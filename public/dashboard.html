<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TWDIW OIDC Client 管理</title>

    <!-- Bulma -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css">

    <!-- DataTables -->
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/datatables.net-dt@2.3.4/css/dataTables.dataTables.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/datatables.net@2.3.4/js/dataTables.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.4/dist/sweetalert2.all.min.js"></script>
    <script defer src="/js/main.js"></script>

</head>

<body class="has-background-light" style="min-height:100vh; display:flex; flex-direction:column;">


    <!-- Main Section -->
    <section class="section is-flex-grow-1">
        <div class="container">
            <div class="box">
                <h1 class="title is-3 mb-4 has-text-centered">OIDC Client 管理</h1>

                <div class="content">
                    <p>於下方建立 OIDC Client，設定 Redirect URIs，並取得 Client ID 與 Client Secret。</p>
                    <ul>
                        <li>Well-known URL：<span class="tag baseurl is-medium">/.well-known/openid-configuration</span>
                        </li>
                        <li>Auth URL：<span class="tag baseurl is-medium">/auth/login</span></li>
                        <li>Token URL：<span class="tag baseurl is-medium">/api/oidc/token</span></li>
                        <li>Certificate URL：<span class="tag baseurl is-medium">/api/oidc/jwks</span></li>
                    </ul>
                </div>

                <div class="has-text-right mb-3">
                    <button id="addBtn" class="button is-primary is-medium has-text-white">新增 Client</button>
                </div>

                <div class="table-container">
                    <table id="clientsTable" class="table is-striped is-fullwidth">
                        <thead>
                            <tr>
                                <th>Client Name</th>
                                <th>Client ID</th>
                                <th>Client Secret</th>
                                <th>Redirect URIs</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <!-- 主要邏輯 -->
    <script>
        (async () => {
            try {
                // 驗證登入狀態
                const response = await fetch('/api/auth/me');
                if (!response.ok) throw new Error('Not authenticated');
                const user = await response.json();
                console.log('Logged in as:', user);

                // 只有成功驗證後，才繼續執行以下內容
                const baseUrl = window.location.origin;
                document.querySelectorAll('.baseurl').forEach(el => {
                    el.textContent = baseUrl + el.textContent;
                });

                // 初始化 DataTable
                const table = new DataTable('#clientsTable', {
                    ajax: { url: '/api/clients', dataSrc: '' },
                    columns: [
                        { data: 'name' },
                        { data: 'client_id' },
                        { data: 'client_secret' },
                        { data: 'redirect_uris' },
                        {
                            data: null,
                            render: (data, type, row) => `
            <div class="buttons are-small">
              <button class="doedit button is-light" data-id="${row.id}">編輯</button>
              <button class="dodelete button is-light" data-id="${row.id}">刪除</button>
            </div>
          `
                        }
                    ],
                    paging: false,
                    searching: false,
                    info: false,
                    ordering: false,
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/2.0.3/i18n/zh-HANT.json'
                    }
                });


                // 新增 Client
                document.getElementById('addBtn').addEventListener('click', async () => {
                    const { value: formValues } = await Swal.fire({
                        title: '新增 Client',
                        html: `
          <div style="text-align:left;">
            <div class="field">
              <label class="label">Client Name</label>
              <div class="control">
                <input id="swal-name" class="input" type="text" placeholder="myapp" required>
              </div>
            </div>
            <div class="field">
              <label class="label">Redirect URIs（以換行分隔）</label>
              <div class="control">
                <textarea id="swal-redirect_uris" class="textarea" placeholder="https://example.com/callback
https://example.org/redirect" required></textarea>
              </div>
            </div>
          </div>`,
                        focusConfirm: false,
                        showCloseButton: true,
                        confirmButtonText: '新增',
                        preConfirm: () => ({
                            name: document.getElementById('swal-name').value.trim(),
                            redirect_uris: document.getElementById('swal-redirect_uris').value.trim()
                        })
                    });

                    if (formValues) {
                        const res = await fetch('/api/clients', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(formValues)
                        });
                        if (res.ok) {
                            Swal.fire('成功', 'Client 已新增', 'success');
                            table.ajax.reload();
                        } else {
                            Swal.fire('錯誤', '新增失敗', 'error');
                        }
                    }
                });

                // 編輯與刪除事件
                document.querySelector('#clientsTable tbody').addEventListener('click', async (e) => {
                    const id = e.target.dataset.id;
                    if (!id) return;

                    // 編輯
                    if (e.target.classList.contains('doedit')) {
                        const res = await fetch(`/api/clients/${id}`);
                        const client = await res.json();

                        const { value: formValues } = await Swal.fire({
                            title: '編輯 Client',
                            html: `
            <div style="text-align:left;">
              <div class="field">
                <label class="label">Client Name</label>
                <div class="control">
                  <input id="swal-name" class="input" type="text" value="${client.name || ''}" required>
                </div>
              </div>
              <div class="field">
                <label class="label">Redirect URIs（以換行分隔）</label>
                <div class="control">
                  <textarea id="swal-redirect_uris" class="textarea" required>${client.redirect_uris || ''}</textarea>
                </div>
              </div>
            </div>`,
                            focusConfirm: false,
                            confirmButtonText: '更新',
                            preConfirm: () => ({
                                name: document.getElementById('swal-name').value.trim(),
                                redirect_uris: document.getElementById('swal-redirect_uris').value.trim()
                            })
                        });

                        if (formValues) {
                            const update = await fetch(`/api/clients/${id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(formValues)
                            });
                            if (update.ok) {
                                Swal.fire('成功', 'Client 已更新', 'success');
                                table.ajax.reload();
                            } else {
                                Swal.fire('錯誤', '更新失敗', 'error');
                            }
                        }
                    }

                    // 刪除
                    if (e.target.classList.contains('dodelete')) {
                        const confirm = await Swal.fire({
                            title: '確認刪除？',
                            text: '此操作無法復原',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: '刪除',
                            cancelButtonText: '取消'
                        });
                        if (confirm.isConfirmed) {
                            const res = await fetch(`/api/clients/${id}`, { method: 'DELETE' });
                            if (res.ok) {
                                Swal.fire('已刪除', '', 'success');
                                table.ajax.reload();
                            } else {
                                Swal.fire('錯誤', '刪除失敗', 'error');
                            }
                        }
                    }
                });

            } catch (error) {
                // 驗證失敗 → 跳轉登入頁
                console.error('Authentication check failed, redirecting to /');
                window.location.href = '/auth/login?redirect_uri=/dashboard';
            }
        })();


    </script>

</body>

</html>